<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Variable Info</title>
    <style>
        /* Style for the container */
        .container {
            display: flex;
            height: 100vh;
            /* Full viewport height */
        }

        /* Style for the left half */
        .left-half {
            width: 50%;
            background-image: url("normal.png");
            background-repeat: no-repeat;
            background-size: 100%;
            background-position: bottom;
            border-right: 2px solid #ccc;
            /* Vertical line */
            padding: 20px;
            box-sizing: border-box;
            overflow: hidden;
            /* Hide scrollbar */
        }


        /* Style for the right half */
        .right-half {
            width: 50%;
            overflow-y: auto;
            /* Enable vertical scrollbar */
            padding: 20px;
            box-sizing: border-box;
        }

        .form-container {
            display: flex;
            flex-direction: column;
            width: 400px;
            margin: 50px auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .form-label {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .form-label label {
            width: 150px;
            margin-right: 10px;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .category-inputs {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 200px;
            /* Set the maximum height */
            overflow-y: auto;
            /* Enable vertical scrolling */
            background-color: white;
        }

        .category-input {
            display: flex;
            gap: 10px;

        }

        .category-input input[type="number"] {
            width: 50px;
        }

        .category-input input[type="text"] {
            flex: 1;
        }

        .table-container {
            margin-top: 20px;
            padding: 20px;
            border-radius: 5px;
            word-wrap: break-word;
            white-space: normal;
        }

        .table-header {
            font-size: 13.2px;
            margin-bottom: 10px;
        }

        .info-line {
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            /* Ensures the table layout is fixed */
        }

        th,
        td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #000000;
            word-wrap: break-word;
            /* Allows breaking of words */
            white-space: normal;
            /* Ensures text can wrap to the next line */
        }

        th {
            background-color: #f2f2f2;
        }

        .varName {
            float: right;
        }

        /* Additional styles */
        .scale-selected {
            background-color: #ecec90;
        }

        .ordinal {
            border: 1px solid #ddd;
            background-color: #82d64d;
        }

        .nominal {
            border: 1px solid #ddd;
            background-color: #4dd6d4;
        }

        .multiple-options {
            background-color: #ffc0cb;
        }

        .disabled {
            pointer-events: none;
            opacity: 0.5;
        }
    </style>

    <script>
        function isValidVariableName(variableName) {
            // Check if the variable name is not empty
            if (variableName.trim() === '') {
                alert("Variable name cannot be empty.");
                return false;
            }

            // Check if the variable name is within the character limit
            if (variableName.length > 32) {
                alert("Variable name exceeds the maximum character limit of 32.");
                return false;
            }

            // Check if the first character is either an underscore (_) or an alphabet character (a-zA-Z)
            const firstChar = variableName[0];
            if (!/^[a-zA-Z_]/.test(firstChar)) {
                alert("Variable name must start with an alphabet or underscore.");
                return false;
            }

            // Check if the variable name contains only valid characters
            const validCharacters = /^[a-zA-Z0-9._]+$/;
            if (!variableName.match(validCharacters)) {
                alert("Variable name can only contain alphanumeric characters, periods, and underscores.");
                return false;
            }

            // Check if the variable name ends with a period or underscore
            if (variableName.endsWith('.') || variableName.endsWith('_')) {
                alert("Variable name cannot end with a period or underscore.");
                return false;
            }

            // Check if the variable name is not a reserved keyword
            const reservedKeywords = ['ALL', 'AND', 'BY', 'EQ', 'GE', 'GT', 'LE', 'LT', 'NE', 'NOT', 'OR', 'TO', 'WITH'];
            if (reservedKeywords.includes(variableName.toUpperCase())) {
                alert("Variable name cannot be a reserved keyword.");
                return false;
            }

            // If all checks pass, return true
            return true;
        }

        function validateVariableNameOnInput() {
            const variableNameInput = document.getElementById('current-variable');
            variableNameInput.addEventListener('input', function () {
                const variableName = variableNameInput.value.trim(); // Trim any leading or trailing whitespace

                if (!isValidVariableName(variableName)) {
                    variableNameInput.classList.add('invalid'); // Apply visual indication for invalid input
                } else {
                    variableNameInput.classList.remove('invalid'); // Remove visual indication for valid input
                }
            });
        }

        validateVariableNameOnInput();

        let previousValue = null;


        function generateCategoryInputs() {
            const numCategories = document.getElementById('num-categories').value;
            const categoryInputsContainer = document.getElementById('category-inputs');
            const measurementLevel = document.getElementById('measurement-level').value;
            categoryInputsContainer.innerHTML = '';


            for (let i = 0; i < numCategories; i++) {
                const div = document.createElement('div');
                div.className = 'category-input';
                div.innerHTML = `
            <input type="number" placeholder="Number" ${measurementLevel === 'Scale' ? 'value="N/A" disabled' : ''} oninput="checkSubsequent(this)">
            <input type="text" placeholder="Category" ${measurementLevel === 'Scale' ? 'value="N/A" disabled' : ''}>
        `;
                categoryInputsContainer.appendChild(div);
            }
        }

        function handleMeasurementLevel() {
            const measurementLevel = document.getElementById('measurement-level').value;
            const typeLabel = document.getElementById('type-label');

            if (measurementLevel === 'Scale' || measurementLevel === 'Ordinal') {
                typeLabel.classList.add('disabled');
                document.getElementById('type').value = 'single option';
                document.getElementById('type').disabled = true;
            } else {
                typeLabel.classList.remove('disabled');
                document.getElementById('type').disabled = false;
            }

            // Generate category inputs with "N/A" if the level is Scale
            generateCategoryInputs();
        }

        function checkSubsequent(input) {
            const currentValue = parseInt(input.value);
            if (previousValue !== null && currentValue === previousValue + 1) {
                const confirmation = confirm("Can I fill the rest of the numbers in the same subsequent manner?");
                if (confirmation) {
                    fillSubsequentNumbers(input);
                }
            }
            previousValue = currentValue;
        }

        function fillSubsequentNumbers(startInput) {
            let currentValue = parseInt(startInput.value);
            let currentInput = startInput.nextElementSibling.parentElement.nextElementSibling.querySelector('input[type="number"]');
            while (currentInput) {
                currentValue++;
                currentInput.value = currentValue;
                currentInput = currentInput.parentElement.nextElementSibling ? currentInput.parentElement.nextElementSibling.querySelector('input[type="number"]') : null;
            }
        }


        function appendRowToTable(tableClassName, variableName, variableLabel) {
            // Find the table with the specified class name
            const table = document.querySelector(`.${tableClassName} tbody`);

            // Create a new row
            const row = document.createElement('tr');

            // Add data to the row
            row.innerHTML = `<td>${variableName}</td><td>${variableLabel}</td>`;

            // Append the row to the table
            table.appendChild(row);
        }

        function saveFormData() {
            const variableName = document.getElementById('current-variable').value;
            const variableLabel = document.getElementById('label').value;
            const measurementLevel = document.getElementById('measurement-level').value;
            let type = document.getElementById('type').value; // Retrieve the response type
            let numCategories = document.getElementById('num-categories').value; // Retrieve the number of categories
            if (!isValidVariableName(variableName)) {
                alert("Invalid variable name. Please correct it before saving.");
                return;
            }
            // If the measurement level is 'Scale', set the response type to 'N/A' and number of categories to 'N/A'
            if (measurementLevel === 'Scale') {
                type = 'N/A';
                numCategories = 'N/A';
            }

            if (measurementLevel === 'Ordinal') {
                type = 'N/A';
            }

            const tablesContainer = document.getElementById('tables-container');

            // Create a new table container
            const tableContainer = document.createElement('div');
            tableContainer.className = 'table-container';
            tablesContainer.appendChild(tableContainer);

            tableContainer.innerHTML = `
        <div class="table-header">
            <strong> <span class="varName">${variableName}</span></strong><br>
            <em>Variable Label:</em> <span>${variableLabel}</span><br>
            <span class="info-line">
                <strong>Level of Measurement:</strong> <span>${measurementLevel}</span><br>
                <strong>Response Type:</strong> <span>${type}</span><br>
                <strong>Number of Categories:</strong> <span>${numCategories}</span><br>
            </span>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Code</th>
                    <th>Category Name</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    `;

            const categoryTableBody = tableContainer.querySelector('tbody');
            const categoryInputs = document.getElementById('category-inputs').querySelectorAll('.category-input');
            categoryInputs.forEach(inputDiv => {
                const number = inputDiv.querySelector('input[type="number"]').value;
                const category = inputDiv.querySelector('input[type="text"]').value;

                const row = document.createElement('tr');
                row.innerHTML = `<td>${number}</td><td>${category}</td>`;
                categoryTableBody.appendChild(row);
            });

            // Make the table container visible
            tableContainer.style.display = 'block';

            // Check for measurement level and apply styles accordingly
            if (measurementLevel === 'Scale') {
                tableContainer.classList.add('scale-selected');
            } else if (measurementLevel === 'Nominal') {
                tableContainer.classList.add('nominal');
            } else {
                tableContainer.classList.add('ordinal');
            }

            if (type === 'multiple options') {
                tableContainer.classList.add('multiple-options');
            }

            // Populate the tables based on measurement level
            appendRowToTable(measurementLevel.toLowerCase() + "-table", variableName, variableLabel);

            // Clear the form inputs
            clearForm();
        }


        function clearForm() {
            document.getElementById('current-variable').value = '';
            document.getElementById('label').value = '';
            document.getElementById('num-categories').value = '';
            document.getElementById('type').value = 'single option';
            document.getElementById('category-inputs').innerHTML = '';
            document.getElementById('measurement-level').value = 'Nominal';
            handleMeasurementLevel();
            previousValue = null;
        }

        function includeStyles() {
            const styles = `
            <style>                
                .table-container {
            margin-top: 20px;
            padding: 20px;
            border-radius: 5px;
            word-wrap: break-word;
            white-space: normal;
            width: 446px;
        }

        .table-header {
            font-size: 15.2px;
            margin-bottom: 10px;
        }

        .info-line {
            font-size: 10pt;
            margin-bottom: 10px;
        }

        table {
                    width: 100%;
                    border-collapse: collapse;
                    table-layout: fixed; /* Ensures the table layout is fixed */
                }
                th, td {
                    padding: 10px;
                    text-align: left;
                    border-bottom: 1px solid #000000;
                    word-wrap: break-word; /* Allows breaking of words */
                    white-space: normal; /* Ensures text can wrap to the next line */
                }
        th {
            background-color: #f2f2f2;
        }

        .varName {
            float: right;
        }

        /* Additional styles */
        .scale-selected {
            background-color: #ecec90;
        }

        .ordinal {
            border: 1px solid #ddd;
            background-color: #82d64d;
        }

        .nominal {
            border: 1px solid #ddd;
            background-color: #4dd6d4;
        }

        .multiple-options {
            background-color: #ffc0cb;
        }

        .tabs{
            width:50%;
            margin-top: 24px;
        }

                #tables-container {
                    display: grid;
                grid-template-columns: repeat(auto-fill, minmax(446px, 1fr));
                grid-gap: 20px;
                }
            <\/style>
            `;
            return styles;
        }

        function includeScript() {
            const scripts = `
            <script>
                function removeButton() {
        var button = document.getElementById("mybtn");
        button.remove();}
        function copyToClipboard() {
            var textToCopy = document.getElementById('textToCopy').innerText;

            // Create a temporary textarea element to hold the text
            var tempTextArea = document.createElement('textarea');
            tempTextArea.value = textToCopy;

            // Append the textarea element to the body
            document.body.appendChild(tempTextArea);

            // Select the text inside the textarea
            tempTextArea.select();

            // Copy the selected text
            document.execCommand('copy');

            // Remove the temporary textarea
            document.body.removeChild(tempTextArea);

            // Alert the user that the text has been copied (optional)
            alert('Code copied!');
        }


    window.onload = function() {
        removeButton();
    }

                <\/script>
                `;
            return scripts;
        }

        function downloadRightHalf() {
            const rightHalfContent = document.querySelector('.right-half').innerHTML;
            const styles = includeStyles();
            const scripts = includeScript();

            const combinedHTML = `
                <!DOCTYPE html>
                <html lang="en">
                    <head>
                        <meta charset="UTF-8">
                            <meta name="viewport" content="width=device-width, initial-scale=1.0">
                                <title>Output</title>
                                ${styles}
                                ${scripts}
                            </head>
                            <body>
                                <div class="vars">
                                    ${rightHalfContent}
                                </div>
                            </body>
                        </html>
        `;

            const rightHalfWindow = window.open('', '_blank');
            rightHalfWindow.document.write(combinedHTML);
            rightHalfWindow.document.close();

            const blob = new Blob([combinedHTML], { type: 'text/html' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'output.html';
            link.click();
        }
        function copyToClipboard() {
            var textToCopy = document.getElementById('textToCopy').innerText;

            // Create a temporary textarea element to hold the text
            var tempTextArea = document.createElement('textarea');
            tempTextArea.value = textToCopy;

            // Append the textarea element to the body
            document.body.appendChild(tempTextArea);

            // Select the text inside the textarea
            tempTextArea.select();

            // Copy the selected text
            document.execCommand('copy');

            // Remove the temporary textarea
            document.body.removeChild(tempTextArea);

            // Alert the user that the text has been copied (optional)
            alert('Code copied!');
        }

    </script>
    </script>
</head>

<body>

    <div class="container">
        <!-- Left half with static form -->
        <div class="left-half">
            <form id="variable-form">
                <div class="form-container">
                    <h2>Variable Info</h2>
                    <div class="form-group">
                        <div class="form-label">
                            <label for="current-variable">Variable name:</label>
                            <input type="text" class="form-input" id="current-variable">
                        </div>
                        <div class="form-label">
                            <label for="label">Label:</label>
                            <input type="text" class="form-input" id="label">
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="form-label">
                            <label for="measurement-level">Measurement Level:</label>
                            <select id="measurement-level" class="form-input" onchange="handleMeasurementLevel()">
                                <option value="Nominal">Nominal</option>
                                <option value="Ordinal">Ordinal</option>
                                <option value="Scale">Scale</option>
                            </select>
                        </div>
                        <div class="form-label" id="type-label">
                            <label for="type">Response Type:</label>
                            <select id="type" class="form-input">
                                <option value="single option">single option</option>
                                <option value="multiple options">multiple options</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="form-label">
                            <label for="num-categories">No of Categories:</label>
                            <input type="number" class="form-input" id="num-categories" min="1">
                            <button type="button" onclick="generateCategoryInputs()"
                                style="height:36px;color: white;background-color:black;margin-left: 10px;">Go</button>
                        </div>
                    </div>
                    <div id="category-inputs" class="category-inputs"></div>
                    <button style="color: white; background-color: blue ;" type="button"
                        onclick="saveFormData()">Save</button>
                </div>
            </form>
        </div>

        <!-- Right half (scrollable) -->
        <div class="right-half">
            <button onclick="downloadRightHalf()" id="mybtn" style="margin-bottom: 20px;">Download as HTML</button>
            <button onclick="copyToClipboard()">Copy code</button>
            <div id="textToCopy" style="display: none;">
                This is the text that will be copied to clipboard.
            </div>
            <div class="additional-section">
                <table class="ordinal-table tabs ordinal">
                    <thead>
                        <tr>
                            <th>Variable Name</th>
                            <th>Variable Label</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Ordinal data goes here -->
                    </tbody>
                </table>
                <table class="nominal-table tabs nominal">
                    <thead>
                        <tr>
                            <th>Variable Name</th>
                            <th>Variable Label</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Nominal data goes here -->
                    </tbody>
                </table>
                <table class="scale-table tabs scale-selected">
                    <thead>
                        <tr>
                            <th>Variable Name</th>
                            <th>Variable Label</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Scale data goes here -->
                    </tbody>
                </table>
            </div>
            <div id="tables-container"></div>
        </div>
    </div>

    </div>

</body>

</html>